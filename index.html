<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Web App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>

<style>
    body {
        display: flex;
        flex-direction: column;
        font-family: Arial, sans-serif;
        align-items: center;
        background-color: #f4f4f4;
        width: 100vw;
        min-height: 100vh;
        margin-left: 0px;
        padding-left: 0px;
        padding-top: 0px;
        margin-top: 0px;
        margin-right: 0px;
        padding-right: 0px;
    }

    .shape {
        position: inherit;
        margin-left: 0px;
        padding-left: 0px;
        padding-top: 0px;
        margin-top: 0px;
        margin-right: 0px;
        padding-right: 0px;
  width: 100%;
  height: 20vh;
  background: url(https://raw.githubusercontent.com/bigfather98/OLJ-keyword/refs/heads/main/OnlineJobsPH.png) no-repeat center center / cover;
  border-radius: 0px;
}

    input {
        font-size: 18px;
        padding: 10px;
        margin-top: 40px;
        width: 60%;
        border: 1px solid #ccc;
        border-radius: 5px;
        margin-bottom: 20px;
    }

    h2 {
        font-size: 18px;
        padding: 10px;
        margin-top: 50px;
        text-align: center;
    } 
    h3 {
        font-size: 12px;
        padding: 10px;
        text-align: center;
        color: gray;
        margin-top: 0px;
    } 

    button {
        font-size: 18px;
        padding: 10px;
        margin-top: 10px;
        width: 60%;
        background-color: #09afb8ff;
        color: white;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        align-text: center;
    }
    .spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255,255,255,.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
        vertical-align: middle; /* Align with text */
        margin-right: 8px; /* Space between spinner and text */
    }

    /* Container for spinner and text */
    .loading-container {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

.center-placeholder::placeholder {
            text-align: center;
            display: block; /* Ensures the placeholder text respects the text alignment */
        }
    
</style>
<body>
    <div class="shape"></div>
    <h2>OLJ only supports an "exact match" keyword. Use 1 word for better search result.</h2>
    <h3>Example: "VA" or "virtual" for Virtual Assistant jobs</h3>
    <input type="text" id="kw1" class="center-placeholder" placeholder="Enter keyword1">
    <input type="text" id="kw2" class="center-placeholder" placeholder="Enter keyword2">
    <input type="text" id="kw3" class="center-placeholder" placeholder="Enter keyword3">
    <input type="text" id="kw4" class="center-placeholder" placeholder="Enter keyword4">
    <input type="text" id="kw5" class="center-placeholder" placeholder="Enter keyword5">
    <button id="submit">Submit</button>
    

    <script>
        window.Telegram.WebApp.expand(); // Expand WebApp to full screen
        
        const tg = window.Telegram.WebApp;
        let userData = tg.initDataUnsafe.user;
        const submitButton = document.getElementById("submit");
        const originalButtonText = submitButton.innerHTML;
        
        const inputFields = [
            document.getElementById("kw1"),
            document.getElementById("kw2"),
            document.getElementById("kw3"),
            document.getElementById("kw4"),
            document.getElementById("kw5")
        ];
        
        async function loadKeywords(chat_id) {
            try {
                const res = await fetch(`https://n8n.kmonlinesolutions.com/webhook/get-keyword?chat_id=${chat_id}`);
                const data = await res.json();
        
                if (data.keywords && Array.isArray(data.keywords)) {
                    for (let i = 0; i < 5; i++) {
                        if (data.keywords[i]) {
                            inputFields[i].value = data.keywords[i];
                        } else {
                            inputFields[i].placeholder = `Enter keyword${i + 1}`;
                        }
                    }
                }
            } catch (err) {
                console.error("Error fetching keywords:", err);
            }
        }
        
        document.getElementById("submit").addEventListener("click", async () => {
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="spinner"></span> Loading...';
        
            const chat_id = userData?.id;
            if (!chat_id) {
                tg.showPopup({ title: 'Error', message: 'Could not get chat ID.', buttons: [{type: 'ok'}] });
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
                return;
            }
        
            const specialCharRegex = /[^a-zA-Z0-9\s]/;
        
            const keywords = inputFields.map((field, i) => {
                const val = field.value.trim();
                if (specialCharRegex.test(val)) {
                    tg.showPopup({
                        title: 'Error',
                        message: `Keyword ${i + 1} has special characters.`,
                        buttons: [{ type: 'ok' }]
                    });
                    throw new Error("Validation failed");
                }
                return val;
            });
        
            const webhookUrl = "https://n8n.kmonlinesolutions.com/webhook/update-keyword";
        
            try {
                const response = await fetch(webhookUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ chat_id, keyword1: keywords[0], keyword2: keywords[1], keyword3: keywords[2], keyword4: keywords[3], keyword5: keywords[4] }),
                });
        
                if (response.ok) {
                    tg.showPopup({ title: 'Success', message: 'Keywords updated.', buttons: [{ type: 'ok' }] });
                    tg.close();
                } else throw new Error("POST failed");
            } catch (error) {
                console.error("Error:", error);
                tg.showPopup({
                    title: 'Error',
                    message: 'Failed to update. Try again.',
                    buttons: [{ type: 'ok' }]
                });
            }
        
            submitButton.disabled = false;
            submitButton.innerHTML = originalButtonText;
        });
        
        if (userData?.id) loadKeywords(userData.id);
        </script>
        

</body>
</html>
